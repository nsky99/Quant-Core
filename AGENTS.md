# 加密货币量化交易框架 Agent 指南

## 项目目标

本项目旨在提供一个基于 Python 和 `ccxtpro` 库的模块化加密货币量化交易框架基础。它包括数据获取、账户管理、订单执行、一个策略引擎（支持从外部文件加载策略、接收多种实时数据流并具有增强的流健壮性和对流失败的主动响应机制），以及一个可配置的风险管理模块（支持全局和策略级参数，并跟踪名义敞口）。

## 当前模块

1.  **`data_fetcher.py`**:
    *   `watch_*_stream` 方法现在接受 `on_permanent_failure_callback` 参数。当流永久失败时（例如，达到最大重试次数或遇到不可恢复错误），会调用此回调，传递失败详情。
    *   其他功能同前 (获取OHLCV, Trades, Ticker数据流，内置健壮的重连逻辑)。

2.  **`account_manager.py`**: (同前)

3.  **`order_executor.py`**:
    *   `watch_orders_stream` 方法现在也接受 `on_permanent_failure_callback` 参数，并在订单流永久失败时调用它。
    *   其他功能同前 (交易执行，内置健壮的订单流重连逻辑)。

4.  **`strategy.py`**: (同前)

5.  **`risk_manager.py`**: (同前)

6.  **`config_loader.py`**: (同前)

7.  **`strategy_engine.py`**:
    *   `StrategyEngine` 类:
        *   **流失败处理 (新增)**:
            *   新增 `_handle_stream_permanent_failure` 内部方法。
            *   当 `DataFetcher` 或 `OrderExecutor` 的某个流通过 `on_permanent_failure_callback` 通知引擎其永久失败时，此方法被调用。
            *   它会记录失败信息，并识别哪些策略依赖于该失败的流。
            *   **响应**: 对于数据流（OHLCV, Trades, Ticker）失败，它会停止所有依赖该特定符号和流类型的活动策略。对于全局订单流失败，它会停止所有活动的策略。
        *   `start` 方法在启动数据流和订单流任务时，会将 `_handle_stream_permanent_failure` (或适配器) 作为失败回调传递。
    *   其他功能 (风险管理集成, 多数据流订阅与分发等) 同前。

8.  **`strategies/` (目录)**: (同前)
9.  **`main.py`**: (同前, 其演示的策略引擎现在能响应流的永久失败)

## 依赖

*   `ccxtpro`, `ccxt`, `pandas`, `numpy`, `PyYAML`.

## 如何配置和运行

(内容与上一版本基本一致)
*   ...
*   **运行演示**: `python main.py`
    *   如果配置了会大概率失败的流（例如，订阅了交易所不支持的交易对的流，或在IP受限环境下），现在应该能观察到引擎在几次重试后（由Fetcher/Executor执行）收到失败通知，并停止相关策略的日志。

## 创建和运行自己的策略

(内容与上一版本基本一致)

## 注意事项

*   **引擎对流失败的响应**: 当一个关键的WebSocket数据流（K线、成交、Ticker）或订单流永久失败后，`StrategyEngine` 目前的默认行为是停止所有依赖该流的活动策略（对于订单流失败，是停止所有活动策略）。这有助于防止策略在没有正确数据输入或订单反馈的情况下继续运行。
*   **流的健壮性**: (同前)
*   **风险参数优先级与合并**: (同前)
*   **敞口跟踪**: (同前)


## 后续开发建议

*   **完善风险管理**: (优先级较高)
    *   实现更复杂的风险规则（例如，基于波动率的订单大小调整、最大回撤限制、多策略间的风险分配）。
    *   `RiskManager.update_on_fill` 可以进一步扩展，例如计算和跟踪已实现/未实现盈亏 (PnL)。
*   **完善策略引擎**:
    *   **引擎对流失败的响应 (进一步增强)**:
        *   允许通过配置决定流失败时的行为（例如，是停止策略、仅告警、还是尝试切换到备用数据源/轮询模式）。
        *   为策略基类添加可选的 `on_stream_failed(stream_info, error)` 回调，让策略有机会自行处理数据流中断（如尝试平仓）。
*   **数据存储与回测**
*   **日志与通知** (例如，当流失败或策略被停止时发送通知)
*   **参数验证** (例如使用 Pydantic 验证配置文件结构和参数类型)

---

请确保在进行任何涉及真实资金的操作之前，充分理解代码和相关风险。
